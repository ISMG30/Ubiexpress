<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Wialon Playground - Get sensors</title>
    <script type="text/javascript" src="//code.jquery.com/jquery-latest.min.js"></script>
    <script type="text/javascript" src="//hst-api.wialon.com/wsdk/script/wialon.js"></script>
</head>
<body>

Select unit: <select id="units"></select>
available sensors <select id="sensors"></select>
<div id="log"></div>

</body>
<script>
    // Print message to log
function msg(text) { $("#log").prepend(text + "<br/>"); }

function init() { // Execute after login succeed
	var sess = wialon.core.Session.getInstance(); // get instance of current Session
	// flags to specify what kind of data should be returned
	var flags = wialon.item.Item.dataFlag.base |
	            wialon.item.Unit.dataFlag.sensors | 
	            wialon.item.Unit.dataFlag.lastMessage;
	sess.loadLibrary("unitSensors"); // load Sensor Library
	sess.updateDataFlags( // load items to current session
	    [{type: "type", data: "avl_unit", flags: flags, mode: 0}], // Items specification
    	function (code) { // updateDataFlags callback
		    if (code) { msg(wialon.core.Errors.getErrorText(code)); return; } // exit if error code  
			
		    var units = sess.getItems("avl_unit"); // get loaded 'avl_unit's items
		    if (!units || !units.length){ msg("No units found"); return; } // check if units found
			
		    for(var i=0; i<units.length; i++) // construct Select list using found units
			    $("#units").append("<option value='"+ units[i].getId() +"'>"+ units[i].getName() +"</option>");
		
		    getSensors(); // get Sensors for currently selected unit
            // bind actions to selects 
		    $("#units").change( getSensors ); 
		    $("#sensors").change( getSensorInfo );
	});
}

function getSensors(){ // construct sensors Select list for selected unit
	if(!$("#units").val()){ msg("Select unit"); return;} // exit if no unit selected
	$("#sensors").html("<option></option>"); // add first empty element
	var sess = wialon.core.Session.getInstance(); // get instance of current Session
	var unit = sess.getItem( $("#units").val() ); // get unit by id
	var sens = unit.getSensors(); // get unit's sensors
	for(var i in sens) // construct select list
		$("#sensors").append("<option value='" + sens[i].id + "'>" + sens[i].n + "</option>");
}

function getSensorInfo(){ // get and show information about selected Sensor
	if(!$("#units").val()){ msg("Select unit"); return;} // exit if no unit selected
	if(!$("#sensors").val()) return; // exit if no unit selected
	var sess = wialon.core.Session.getInstance(); // get instance of current Session
	var unit = sess.getItem( $("#units").val() ); // get unit by id
	var sens = unit.getSensor( $("#sensors").val() ); // get sensor by id
	// calculate sensor value
	var result = unit.calculateSensorValue(sens, unit.getLastMessage());
	if(result == -348201.3876) result = "N/A"; // compare result with invalid sensor value constant
	// print result message
	msg("Value of "+ unit.getName() +" <b>'"+ sens.n +"'</b> sensor ("+ sens.t +"): "+ result + " ("+ sens.m +")");
	msg("Combustible"+result+"("+sens.m+")")
}

// execute when DOM ready
$(document).ready(function () {
	msg("Trying to login");
	wialon.core.Session.getInstance().initSession("http://local.ubiexpress.net"); // init session
    // For more info about how to generate token check
    // http://sdk.wialon.com/playground/demo/app_auth_token
	wialon.core.Session.getInstance().loginToken("2f0a8929ad515bb67157ead976434d583BCAEAF887B0551E3F8C07590A59533902946CAA", "", // try to login
    function (code) { // login callback
        if (code){ msg(wialon.core.Errors.getErrorText(code)); return; } // exit if error code
		msg("Logged successfully"); init(); // when login suceed then run init() function
	});
});
    </script>
</html>
